apiVersion: v1
kind: Template
metadata:
  name: logcollector
objects:
#
# Deployment of fluentd log collector
#
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: fluentd
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: fluentd
    template:
      metadata:
        labels:
          app: fluentd
      spec:
        containers:
        - image: ${fluentd_image}
          securityContext:
            privileged: true
            allowPrivilegeEscalation: true
          imagePullPolicy: Always
          name: fluentd
          command: ["/bin/bash"]
          args:
            - -c
            - >
              rm -r /var/log/containers/fluentd.stresslog;
              rm /var/log/containers/stress.log;
              /usr/local/bin/fluentd -c /etc/fluentd/fluentd.conf;
              while true; do
                echo ".";
                sleep 60;
              done;
          volumeMounts:
          - name: varlog
            mountPath: /var/log
          - name: config-path
            mountPath: /etc/fluentd
        restartPolicy: Always
        volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: config-path
          configMap:
            name: fluentd-config        
#
# Service for fluentd forward port
#
- apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: fluentd
    name: fluentd-forward
  spec:
    ports:
      - name: forward
        port: 24224
        protocol: TCP
        targetPort: 24224
    selector:
      app: fluentd
    sessionAffinity: None
    type: ClusterIP
parameters:
  - name: fluentd_image
