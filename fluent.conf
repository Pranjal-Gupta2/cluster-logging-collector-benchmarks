<source>
  @type tail_with_throttle
  @id container-input-throttle
  @log_level debug
  path "/var/log/containers/heavy-log-stress*.log,/var/log/containers/low-log-stress*.log"
  exclude_path ["/var/log/containers/fluentd-*_openshift-logging_*.log", "/var/log/containers/elasticsearch-*_openshift-logging_*.log", "/var/log/containers/kibana-*_openshift-logging_*.log"]
  pos_file "/var/log/containers-throttle.log.pos"
  path_key path
  refresh_interval 1s
  rotate_wait 0.5s
  tag kubernetes.*
  @label @MEASURE

  <group>
    rate_period 1s
    <rule>
      appname low-log-stress
      limit 2000
    </rule>
    <rule>
      appname heavy-log-stress 
      limit 4000
    </rule>
  </group>

  <parse>
    @type multi_format
    <pattern>
      format json
      time_format '%Y-%m-%dT%H:%M:%S.%N%Z'
      keep_time_key true
    </pattern>
    <pattern>
      format regexp
      expression /^(?<time>[^\s]+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
      time_format '%Y-%m-%dT%H:%M:%S.%N%:z'
      keep_time_key true
    </pattern>
  </parse>
</source>

# <source>
#   @type tail
#   @id container-input
#   @log_level debug
#   path "/var/log/containers/low-log-stress*.log,/var/log/containers/heavy-log-stress*.log"
#   exclude_path ["/var/log/containers/fluentd-*_openshift-logging_*.log", "/var/log/containers/elasticsearch-*_openshift-logging_*.log", "/var/log/containers/kibana-*_openshift-logging_*.log"]
#   pos_file "/var/log/containers.log.pos"
#   read_bytes_limit_per_second 1000
#   path_key path
#   refresh_interval 1s

#   rotate_wait 5s
#   tag kubernetes.*
#   @label @MEASURE
#   <parse>
#     @type multi_format
#     <pattern>
#       format json
#       time_format '%Y-%m-%dT%H:%M:%S.%N%Z'
#       keep_time_key true
#     </pattern>
#     <pattern>
#       format regexp
#       expression /^(?<time>[^\s]+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
#       time_format '%Y-%m-%dT%H:%M:%S.%N%:z'
#       keep_time_key true
#     </pattern>
#   </parse>
# </source>


<source>
  @type prometheus
</source>

<label @MEASURE>
  <filter **>
    @type prometheus
    <metric> 
      name fluentd_input_status_num_records_total
      type counter
      desc The total number of incoming records
      <labels>
        tag ${tag}
        hostname ${hostname}
      </labels>
    </metric>
  </filter>

  <match kubernetes.var.log.containers.low-log-stress**>
	  @type file
    @id low-log
    @log_level debug
	  path /var/log/containers/fluentd.low.stresslog
	  # symlink_path /var/log/containers/stress.log
    <buffer time>
      @type memory
      overflow_action throw_exception
      timekey 10s
      timekey_wait 1s
      flush_thread_interval 10s
      total_limit_size 1073741824 # 1 GB buffer size
    </buffer>
  </match>

  <match kubernetes.var.log.containers.heavy-log-stress**>
	  @type file
    @id heavy-log
    @log_level debug
	  path /var/log/containers/fluentd.heavy.stresslog
	  # symlink_path /var/log/containers/stress.log
    <buffer time>
      @type memory
      overflow_action throw_exception
      timekey 10s
      timekey_wait 1s
      flush_thread_interval 10s
      total_limit_size 1073741824 # 1 GB buffer size
    </buffer>
  </match>
</label>